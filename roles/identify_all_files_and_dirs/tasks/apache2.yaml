
- name: Find all .conf and .load files under /etc/apache2/
  find:
    paths: "/etc/apache2"
    recurse: yes
    patterns: "*.conf"
  register: conf_files

- name: Find all .load files under /etc/apache2/
  find:
    paths: "/etc/apache2"
    recurse: yes
    patterns: "*.load"
  register: load_files

- name: Combine the results into a single list
  set_fact:
    all_files: "{{ conf_files.files + load_files.files }}"

- name: Read the content of each file
  slurp:
    src: "{{ item.path }}"
  loop: "{{ all_files }}"
  register: file_contents

- name: Extract paths from the file content excluding comment lines and invalid paths
  set_fact:
    paths_found: "{{ paths_found | default([]) + (item.content | b64decode | regex_findall('(?:^|\\s)(/([a-zA-Z0-9_\\-\\/]+))(\\s|$)')) }}"
  loop: "{{ file_contents.results }}"

- name: Clean up paths by removing unwanted characters like newline and space
  set_fact:
    cleaned_paths: "{{ paths_found | map('regex_replace', '[\\n\\r\\s]+', '') | selectattr('search', '^/') | list }}"

- name: Remove duplicate paths
  set_fact:
    unique_paths: "{{ cleaned_paths | unique }}"

- name: Display all found valid paths
  debug:
    msg: "{{ unique_paths }}"

# - name: Find all .conf and .load files under /etc/apache2/
#   find:
#     paths: "/etc/apache2"
#     recurse: yes
#     patterns: "*.conf"
#   register: conf_files

# - name: Find all .load files under /etc/apache2/
#   find:
#     paths: "/etc/apache2"
#     recurse: yes
#     patterns: "*.load"
#   register: load_files

# - name: Combine the results and display all files
#   set_fact:
#     all_files: "{{ conf_files.files + load_files.files }}"

# - name: Display all the matching files
#   debug:
#     msg: "{{ all_files | map(attribute='path') | list }}"